CVAULT-146: Optimize API Response Times and Add Request Caching
================================================================

Task: Optimize API response times and implement request caching for the Consensus Vault Next.js application.

Date: 2026-02-08
Engineer: Autonomous Agent

PHASE 1: Discovery & Profiling
------------------------------

1.1 API Routes Identified:
- /api/consensus (GET - SSE streaming, POST - batch)
- /api/consensus-detailed (GET, POST)
- /api/price (GET)
- /api/prediction-market/bet (GET, POST)
- /api/prediction-market/stream (GET - SSE)
- /api/trading/execute (POST)
- /api/trading/close (POST)
- /api/trading/history (GET)
- /api/chatroom/stream (GET - SSE)

1.2 Current Caching Status:
✅ /api/price - Has edge caching (30s TTL)
✅ /api/consensus-detailed - Has edge caching (60s TTL) + memoization
✅ /api/trading/history - Has edge caching (5s TTL)
✅ /api/prediction-market/bet GET - Has short cache (5s TTL)
❌ /api/consensus POST - No caching (AI calls are expensive)
❌ /api/trading/execute - No caching (but calls consensus)
❌ /api/trading/close - No caching (state mutation)
❌ /api/prediction-market/bet POST - No caching (state mutation)

1.3 SSE Endpoints (No caching per requirements):
- /api/consensus (GET)
- /api/prediction-market/stream
- /api/chatroom/stream

PHASE 2: Optimization Strategy
------------------------------

2.1 Implement Response Time Middleware
- Create middleware to track and log response times
- Add performance headers to all responses

2.2 Enhance AI Response Caching
- Cache AI model responses based on prompt hash
- 30-60s TTL for identical prompts
- Implement request deduplication for concurrent identical requests

2.3 Add Stale-While-Revalidate Pattern
- For price data: 30s max-age, 60s stale-while-revalidate
- For consensus: 60s max-age, 120s stale-while-revalidate

2.4 Implement Request Deduplication
- In-memory deduplication for concurrent identical AI requests
- Prevents duplicate API calls to expensive AI models

2.5 Add Performance Metrics
- Response time logging for all endpoints
- Cache hit/miss tracking
- Export metrics for monitoring

PHASE 3: Implementation
------------------------

Files to modify:
1. src/lib/cache.ts - Add AI response caching, deduplication
2. src/lib/consensus-engine.ts - Add response time tracking, caching hooks
3. src/lib/api-logger.ts - Add performance metrics export
4. src/app/api/consensus/route.ts - Add caching for POST endpoint
5. src/app/api/trading/execute/route.ts - Add caching for consensus calls
6. src/middleware.ts - Create response time tracking middleware

Files to create:
1. src/lib/ai-cache.ts - AI-specific caching layer
2. src/lib/performance-metrics.ts - Metrics collection and export

PHASE 4: Testing & Verification
--------------------------------

- Verify cache headers on all endpoints
- Test request deduplication
- Measure response time improvements
- Ensure SSE endpoints are not cached
- Verify no breaking changes

